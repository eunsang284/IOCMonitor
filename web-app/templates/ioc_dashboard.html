{% extends "base.html" %}

{% block title %}EPICS IOC Dashboard{% endblock %}

{% block extra_css %}
<style>
    .status-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .status-card {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #00a2cc;
        text-align: center;
    }
    .status-card h3 {
        margin-top: 0;
        color: #495057;
    }
    .status-value {
        font-size: 2em;
        font-weight: bold;
        color: #28a745;
    }
    .refresh-btn {
        background-color: #00a2cc;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
        margin-bottom: 20px;
    }
    .refresh-btn:hover {
        background-color: #008bb0;
    }
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    .error {
        background-color: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .table {
        margin-top: 20px;
        background: white;
        border-collapse: collapse;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        width: 100%;
    }
    .table th {
        background-color: #00a2cc;
        color: white;
        padding: 12px;
        text-align: center;
        font-weight: bold;
        border: 1px solid #ddd;
    }
    .table td {
        padding: 10px;
        text-align: left;
        border: 1px solid #ddd;
        vertical-align: middle;
    }
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    .status-online {
        color: #155724;
        font-weight: bold;
    }
    .status-error {
        color: #721c24;
        font-weight: bold;
    }
    .status-unknown {
        color: #856404;
        font-weight: bold;
    }
    .ioc-name {
        font-weight: bold;
        color: #00a2cc;
    }
    .detail-btn {
        background-color: #00a2cc;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.9em;
    }
    .detail-btn:hover {
        background-color: #008bb0;
    }
    .ssh-btn {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.9em;
        margin-left: 5px;
    }
    .ssh-btn:hover {
        background-color: #218838;
    }
    .mask-btn {
        background-color: #ffc107;
        color: #212529;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.9em;
        margin-left: 5px;
    }
    .mask-btn:hover {
        background-color: #e0a800;
    }
    .delete-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.9em;
        margin-left: 5px;
    }
    .delete-btn:hover {
        background-color: #c82333;
    }
    @media (max-width: 768px) {
        .table {
            font-size: 0.9em;
        }
        .table th, .table td {
            padding: 8px 4px;
        }
    }
</style>
{% endblock %}

{% block content %}
<h2>IOC Dashboard</h2>

<button class="refresh-btn" onclick="refreshData()">Refresh Data</button>

<div class="status-summary">
    <div class="status-card">
        <h3>Total IOCs</h3>
        <div id="total-iocs" class="status-value">-</div>
    </div>
    <div class="status-card">
        <h3>Online IOCs</h3>
        <div id="online-iocs" class="status-value">-</div>
    </div>
    <div class="status-card">
        <h3>Error IOCs</h3>
        <div id="error-iocs" class="status-value">-</div>
    </div>
    <div class="status-card">
        <h3>Last Update</h3>
        <div id="last-update" class="status-value">-</div>
    </div>
</div>

<div id="error-message" class="error" style="display: none;"></div>

<div id="ioc-container">
    <div class="loading">Loading IOC data...</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentIocDetails = {};
    
    // Load initial data
    loadStatusSummary();
    loadIocList();
    
    // Refresh data every 10 seconds
    setInterval(() => {
        loadStatusSummary();
        loadIocList();
    }, 10000);
    
    function loadStatusSummary() {
        fetch('/api/alive/status')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-iocs').textContent = data.total_iocs;
                document.getElementById('online-iocs').textContent = data.online_iocs;
                document.getElementById('error-iocs').textContent = data.error_iocs;
                
                if (data.last_update) {
                    const updateTime = new Date(data.last_update);
                    document.getElementById('last-update').textContent = 
                        updateTime.toLocaleTimeString();
                }
            })
            .catch(error => {
                console.error('Error loading status summary:', error);
                showError('Failed to load status summary');
            });
    }
    
    function loadIocList() {
        fetch('/api/alive/ioc_details')
            .then(response => response.json())
            .then(data => {
                currentIocDetails = data;
                displayIocTable(data);
                hideError();
            })
            .catch(error => {
                console.error('Error loading IOC list:', error);
                showError('Failed to load IOC list');
            });
    }
    
    function displayIocTable(iocDetails) {
        const container = document.getElementById('ioc-container');
        
        if (Object.keys(iocDetails).length === 0) {
            container.innerHTML = '<div class="loading">No IOCs found</div>';
            return;
        }
        
        const table = document.createElement('table');
        table.className = 'table table-bordered table-striped';
        
        // Create header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = [
            'IOC Name',
            'Status',
            'IP Address',
            'Engineer',
            'Location',
            'Purpose',
            'BPC',
            'Incarnation',
            'Last Seen',
            'Uptime',
            'Message',
            'Actions'
        ];
        
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // Create body
        const tbody = document.createElement('tbody');
        
        Object.values(iocDetails).forEach(ioc => {
            const row = document.createElement('tr');
            
            // IOC Name
            const nameCell = document.createElement('td');
            nameCell.className = 'ioc-name';
            nameCell.textContent = ioc.name;
            row.appendChild(nameCell);
            
            // Status
            const statusCell = document.createElement('td');
            statusCell.className = getStatusClass(ioc.status);
            statusCell.textContent = ioc.status;
            row.appendChild(statusCell);
            
            // IP Address
            const ipCell = document.createElement('td');
            ipCell.textContent = ioc.ip_address;
            row.appendChild(ipCell);
            
            // Engineer
            const engCell = document.createElement('td');
            engCell.textContent = ioc.ENGINEER || 'N/A';
            row.appendChild(engCell);
            
            // Location
            const locCell = document.createElement('td');
            locCell.textContent = ioc.LOCATION || 'N/A';
            row.appendChild(locCell);
            
            // Purpose
            const purpCell = document.createElement('td');
            purpCell.textContent = ioc.PURPOSE || 'N/A';
            row.appendChild(purpCell);
            
            // BPC
            const bpcCell = document.createElement('td');
            bpcCell.textContent = ioc.BPC || 'N/A';
            row.appendChild(bpcCell);
            
            // Incarnation
            const incCell = document.createElement('td');
            incCell.textContent = ioc.incarnation;
            row.appendChild(incCell);
            
            // Last Seen
            const seenCell = document.createElement('td');
            seenCell.textContent = ioc.last_seen;
            row.appendChild(seenCell);
            
            // Uptime
            const uptimeCell = document.createElement('td');
            uptimeCell.textContent = ioc.uptime;
            row.appendChild(uptimeCell);
            
            // Message
            const msgCell = document.createElement('td');
            msgCell.textContent = ioc.message;
            row.appendChild(msgCell);
            
            // Actions
            const actionCell = document.createElement('td');
            
            // Details button
            const detailBtn = document.createElement('button');
            detailBtn.className = 'detail-btn';
            detailBtn.textContent = 'Details';
            detailBtn.onclick = () => window.open(`/log/${encodeURIComponent(ioc.name)}`, '_blank');
            actionCell.appendChild(detailBtn);
            
            // SSH button
            const sshBtn = document.createElement('button');
            sshBtn.className = 'ssh-btn';
            sshBtn.textContent = 'SSH';
            sshBtn.onclick = () => connectSSH(ioc.name);
            actionCell.appendChild(sshBtn);
            
            // Mask/Unmask button
            const maskBtn = document.createElement('button');
            maskBtn.className = 'mask-btn';
            maskBtn.textContent = ioc.masked ? 'Unmask' : 'Mask';
            maskBtn.onclick = () => toggleMask(ioc.name);
            actionCell.appendChild(maskBtn);
            
            // Delete button (only for offline IOCs)
            if (ioc.status === 'OFFLINE') {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteIOC(ioc.name);
                actionCell.appendChild(deleteBtn);
            }
            
            row.appendChild(actionCell);
            
            tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
        
        container.innerHTML = '';
        container.appendChild(table);
    }
    
    function getStatusClass(status) {
        if (status === 'ONLINE' || status === 'RUNNING') {
            return 'status-online';
        } else if (status === 'ERROR' || status === 'FAILED') {
            return 'status-error';
        } else {
            return 'status-unknown';
        }
    }
    
    function refreshData() {
        loadStatusSummary();
        loadIocList();
    }
    
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }
    
    function hideError() {
        document.getElementById('error-message').style.display = 'none';
    }
    
                function connectSSH(iocName) {
                    fetch(`/api/ssh/${encodeURIComponent(iocName)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'ok') {
                                // SSH 터미널 창 열기
                                const terminalWindow = window.open(`/terminal/${encodeURIComponent(iocName)}`, '_blank', 'width=800,height=600');
                            } else {
                                alert(`SSH 연결 실패: ${data.message}`);
                            }
                        })
                        .catch(error => {
                            console.error('SSH 연결 오류:', error);
                            alert('SSH 연결 중 오류가 발생했습니다.');
                        });
                }
    
    function toggleMask(iocName) {
        fetch('/api/toggle_mask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ioc: iocName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                alert(`IOC ${iocName} ${data.action} 완료`);
                loadIocList(); // 테이블 새로고침
            } else {
                alert(`마스크 토글 실패: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('마스크 토글 오류:', error);
            alert('마스크 토글 중 오류가 발생했습니다.');
        });
    }
    
    function deleteIOC(iocName) {
        if (!confirm(`정말로 IOC "${iocName}"을 삭제하시겠습니까?`)) {
            return;
        }
        
        fetch(`/api/delete?ioc=${encodeURIComponent(iocName)}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                alert(`IOC ${iocName} 삭제 완료`);
                loadIocList(); // 테이블 새로고침
            } else {
                alert(`삭제 실패: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('삭제 오류:', error);
            alert('삭제 중 오류가 발생했습니다.');
        });
    }
</script>
{% endblock %} 